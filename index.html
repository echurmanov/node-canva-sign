<!doctype html>
<html>
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        function init(){

            socket.on("show image", function (imageIndex){
                window.location.href="/image?i=" + imageIndex
            });

            var flag = false;
            var canvas = document.getElementById("canvas");
            document.getElementById("clear").addEventListener("click", erase);
            document.getElementById("save").addEventListener("click", save);

            var ctx = canvas.getContext("2d");
            var w = canvas.width;
            var h = canvas.height;
            var currX = 0;
            var currY = 0;

            canvas.addEventListener("mousemove", function (e) {
                findxy('move', e)
            }, false);
            canvas.addEventListener("touchmove", function (e) {
                findxy('move', e)
            }, false);
            canvas.addEventListener("mousedown", function (e) {
                findxy('down', e)
            }, false);
            canvas.addEventListener("touchstart", function (e) {
                findxy('down', e)
            }, false);
            canvas.addEventListener("mouseup", function (e) {
                findxy('up', e)
            }, false);
            canvas.addEventListener("touchend", function (e) {
                findxy('up', e)
            }, false);
            canvas.addEventListener("mouseout", function (e) {
                findxy('out', e)
            }, false);
            canvas.addEventListener("touchcancel", function (e) {
                findxy('out', e)
            }, false);

            function draw() {
                ctx.beginPath();
                ctx.moveTo(prevX, prevY);
                ctx.lineTo(currX, currY);
                ctx.strokeStyle = "black";
                ctx.lineWidth = "2";
                ctx.stroke();
                ctx.closePath();
            }

            function findxy(res, e) {
                if (res == 'down') {
                    prevX = currX;
                    prevY = currY;
                    currX = e.clientX - canvas.offsetLeft;
                    currY = e.clientY - canvas.offsetTop;

                    flag = true;
                }
                if (res == 'up' || res == "out") {
                    flag = false;
                }
                if (res == 'move') {
                    if (flag) {
                        prevX = currX;
                        prevY = currY;
                        currX = e.clientX - canvas.offsetLeft;
                        currY = e.clientY - canvas.offsetTop;
                        draw();
                    }
                }
            }

            function erase() {
                ctx.clearRect(0, 0, w, h);
            }

            function save() {
                socket.emit("save image", canvas.toDataURL("image/png"));
            }

        }

    </script>
</head>
<body onload="init()">
    <canvas id="canvas" width="300" height="200" style="border:1px black solid; cursor: default;"></canvas>
    <br/>
<button id="clear">Очистить</button>
<button id="save">Сохранить</button>
</body>
</html>